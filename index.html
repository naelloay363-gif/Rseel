!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ v23</title>
<link rel="manifest" href="./manifest.webmanifest"/>
<meta name="theme-color" content="#2878ff"/>
<style>
:root{--primary:#2878ff;--success:#1a9d5c;--danger:#dc3545;--muted:#6c757d}
*{box-sizing:border-box}
body{font-family:Tahoma,Arial,sans-serif;margin:0;background:#eaf1ff;color:#111}
header{position:sticky;top:0;background:var(--primary);color:#fff;padding:10px 12px;z-index:5}
header h1{margin:0 0 4px;font-size:18px}
header .sub{font-size:13px;opacity:.95}
main{padding:12px 12px 120px;max-width:980px;margin:auto}
.card{background:#fff;border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 2px 10px rgba(0,0,0,.06)}
label{font-size:14px;color:#333}
input,select,textarea,button{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px}
input.slim, .slim{height:42px;padding:10px 12px}
button{border:none}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border-radius:14px;padding:10px 14px;font-size:14px}
.btn-primary{background:var(--primary);color:#fff}
.btn-success{background:var(--success);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-outline{background:#fff;border:1px solid #e5e7eb;color:#111}
.row{display:flex;gap:8px;flex-wrap:wrap}
.col{flex:1;min-width:180px}
.hint{font-size:12px;color:#555;margin-top:6px}
.list{margin-top:8px}
.item{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #f0f0f0;font-size:14px}
.item:last-child{border-bottom:none}
.item .meta{flex:1}
.kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:8px}
.kpi .box{background:#f1f6ff;border:1px solid #e5edff;border-radius:12px;padding:10px;text-align:center}
.kpi .box b{display:block;font-size:16px}
.tabs{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #eee;display:flex}
.tab{flex:1;text-align:center}
.tab button{width:100%;border:none;background:#fff;padding:12px 0}
.tab.active{background:#f8faff}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #eee;padding:8px;text-align:center;font-size:14px}
th{background:#f9fbff}
.subtle{background:#fafbff;border:1px solid #eef1ff;border-radius:12px;padding:10px;margin-top:8px}
details summary{cursor:pointer;font-weight:bold}
.no-print{}
@media print{ header,nav.tabs,.no-print{display:none!important} body{background:#fff} .card{box-shadow:none;border:none} }
</style>
</head>
<body>
<header class="no-print">
  <h1>Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ v23</h1>
  <div class="sub">Ø§Ù„Ù…Ø§Ù„Ùƒ: <b>Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶</b></div>
</header>

<main>

  <div class="card no-print">
    <div class="row">
      <div class="col">
        <label>Ø§Ù„Ù…Ø­Ù„</label>
        <select id="storeSelect" onchange="changeStore()">
          <option value="store1">Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ</option>
          <option value="store2">Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯</option>
          <option value="store3">Ø¨Ø³Ø·Ø©</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
  <section class="card" data-tab="input">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
    <div class="row">
      <div class="col"><input type="number" id="saleAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
      <div class="col">
        <select id="saleType">
          <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
          <option value="Ø¨Ù†Ùƒ">Ø¨Ù†Ùƒ</option>
        </select>
      </div>
    </div>
    <input type="text" id="saleNote" class="slim" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (ØµÙ†Ù/Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ/Ø¬ÙˆØ§Ù„) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
    <div style="margin-top:8px"><button class="btn btn-success" onclick="addSale()">Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ¹</button></div>
    <div class="list" id="recentSales"></div>
  </section>

  <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ -->
  <section class="card" data-tab="input">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
    <div class="row">
      <div class="col"><input type="text" id="expenseDesc" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ"></div>
      <div class="col"><input type="number" id="expenseAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
      <div class="col">
        <select id="expenseType">
          <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
          <option value="Ø¨Ù†Ùƒ">Ø¨Ù†Ùƒ</option>
        </select>
      </div>
    </div>
    <input type="text" id="expenseNote" class="slim" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <div class="subtle">
      <div class="row">
        <div class="col"><input type="checkbox" id="expenseIsTrader" onchange="toggleExpenseTrader(this.checked)"> <label for="expenseIsTrader"><b>Ø§Ø¹ØªØ¨Ø§Ø±Ù‡Ø§ Ø³Ø¯Ø§Ø¯ Ù„ØªØ§Ø¬Ø±</b></label></div>
      </div>
      <div class="row" id="expenseTraderRow" style="display:none">
        <div class="col">
          <label>Ø§Ù„ØªØ§Ø¬Ø±</label>
          <select id="expenseTrader"></select>
        </div>
        <div class="col"><input type="text" id="expenseTraderNote" class="slim" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
      </div>
      <div class="hint">Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ØŒ ÙŠÙØ®ØµÙ… Ù†ÙØ³ Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØµØ±ÙˆÙ Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„ØªØ§Ø¬Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹).</div>
    </div>

    <div class="subtle">
      <div class="row">
        <div class="col"><input type="checkbox" id="expenseIsLoan" onchange="toggleExpenseLoan(this.checked)"> <label for="expenseIsLoan"><b>Ø§Ø¹ØªØ¨Ø§Ø±Ù‡Ø§ Ø¯ÙØ¹Ø© Ù…Ù† Ø³Ù„ÙØ©</b> (ÙƒØ§Ø´ ÙÙ‚Ø·)</label></div>
      </div>
      <div class="row" id="expenseLoanRow" style="display:none">
        <div class="col">
          <label>Ø§Ù„Ù…ÙØ³Ù„Ù</label>
          <select id="expenseLoanPerson"></select>
        </div>
        <div class="col"><input type="text" id="expenseLoanNote" class="slim" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
      </div>
      <div class="hint">ÙŠÙØ®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙØ³Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± ÙˆÙŠÙØ³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙÙŠ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ….</div>
    </div>

    <div style="margin-top:8px"><button class="btn btn-success" onclick="addExpense()">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button></div>
    <div class="list" id="recentExpenses"></div>
  </section>

  <!-- Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
  <section class="card" data-tab="daily">
    <h3>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ)</h3>
    <div class="row no-print">
      <div class="col"><input type="date" id="r_date"></div>
      <div class="col"><button class="btn btn-primary" onclick="generateReport()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
      <div class="col"><button class="btn btn-outline" onclick="printSection('dailyReportWrap')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button></div>
      <div class="col"><button class="btn btn-outline" onclick="exportDailyExcel()">ğŸ“Š Excel</button></div>
    </div>
    <div id="dailyReportWrap">
      <div id="dailyKPI" class="kpi" style="display:none">
        <div class="box"><b id="k_cash_sales">0</b><span>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</span></div>
        <div class="box"><b id="k_bank_sales">0</b><span>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</span></div>
        <div class="box"><b id="k_cash_exp">0</b><span>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</span></div>
        <div class="box"><b id="k_bank_exp">0</b><span>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</span></div>
      </div>
      <div id="dailyReport"></div>
    </div>
  </section>

  <!-- Ø§Ù„ØªÙØ¬Ù‘Ø§Ø± -->
  <section class="card" data-tab="traders">
    <h3>Ø§Ù„ØªÙØ¬Ù‘Ø§Ø±</h3>

    <div class="subtle no-print">
      <h4>Ø¥Ø¶Ø§ÙØ© ØªØ§Ø¬Ø±</h4>
      <div class="row">
        <div class="col"><input type="text" id="t_name" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±"></div>
        <div class="col"><input type="text" id="t_phone" placeholder="Ø¬ÙˆØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
      </div>
      <button class="btn btn-success" onclick="addTrader()">â• Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <div class="subtle no-print">
      <h4>Ø´Ø±Ø§Ø¡ Ø¨Ø¶Ø§Ø¹Ø©</h4>
      <div class="row">
        <div class="col"><label>Ø§Ù„ØªØ§Ø¬Ø±</label><select id="p_trader"></select></div>
        <div class="col"><input type="number" id="p_total" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©"></div>
      </div>
      <div class="row">
        <div class="col"><input type="number" id="p_from_shop_cash" placeholder="Ø¯ÙØ¹Ø© Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„"></div>
        <div class="col"><input type="number" id="p_from_shop_bank" placeholder="Ø¯ÙØ¹Ø© Ù…Ù† Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø­Ù„"></div>
      </div>
      <div class="row">
        <div class="col"><input type="number" id="p_from_owner_cash" placeholder="Ø¯ÙØ¹Ø© Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ"></div>
      </div>
      <input type="text" id="p_note" class="slim" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø©/ØªÙØ§ØµÙŠÙ„) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
      <button class="btn btn-primary" onclick="purchaseFromTrader()">ğŸ§¾ ØªØ³Ø¬ÙŠÙ„ Ø´Ø±Ø§Ø¡</button>
      <div class="hint">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙŠÙØ³Ø¬Ù„ Ø¯ÙŠÙ†Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±.</div>
    </div>

    <div class="subtle no-print">
      <h4>Ø³Ø¯Ø§Ø¯ ØªØ§Ø¬Ø±</h4>
      <div class="row">
        <div class="col"><label>Ø§Ù„ØªØ§Ø¬Ø±</label><select id="pay_trader"></select></div>
        <div class="col">
          <select id="pay_source">
            <option value="shop_cash">Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„</option>
            <option value="shop_bank">Ù…Ù† Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø­Ù„</option>
            <option value="owner_cash">Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col"><input type="number" id="pay_amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
        <div class="col"><input type="text" id="pay_note" class="slim" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
      </div>
      <button class="btn btn-outline" onclick="payTrader()">ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯</button>
    </div>

    <div class="subtle">
      <h4>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ ØªØ§Ø¬Ø±</h4>
      <div class="row no-print">
        <div class="col"><select id="s_trader" onchange="renderTraderStatement()"></select></div>
        <div class="col"><button class="btn btn-outline" onclick="printSection('traderStatement')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button></div>
        <div class="col"><button class="btn btn-outline" onclick="exportTableAsExcel('traderStatementTable','ÙƒØ´Ù-ØªØ§Ø¬Ø±')">ğŸ“Š Excel</button></div>
      </div>
      <div id="traderStatement"></div>
    </div>

    <div class="subtle">
      <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙØ¬Ø§Ø± ÙˆØ£Ø±ØµØ¯ØªÙ‡Ù…</h4>
      <div id="tradersList"></div>
    </div>
  </section>

  <!-- Ø§Ù„Ø³ÙÙ„Ù -->
  <section class="card" data-tab="loans">
    <h3>Ø§Ù„Ø³ÙÙ„Ù</h3>

    <div class="subtle no-print">
      <h4>Ø¥Ø¶Ø§ÙØ© Ù…ÙØ³Ù„Ù</h4>
      <div class="row">
        <div class="col"><input type="text" id="l_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØ³Ù„Ù"></div>
        <div class="col"><input type="text" id="l_phone" placeholder="Ø¬ÙˆØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
      </div>
      <button class="btn btn-success" onclick="addLender()">â• Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <div class="subtle no-print">
      <h4>Ø£Ø®Ø° Ø³Ù„ÙØ© (ÙƒØ§Ø´)</h4>
      <div class="row">
        <div class="col"><label>Ø§Ù„Ù…ÙØ³Ù„Ù</label><select id="loan_person"></select></div>
        <div class="col"><input type="number" id="loan_amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
      </div>
      <input type="text" id="loan_note" class="slim" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      <button class="btn btn-primary" onclick="takeLoan()">ğŸ’µ ØªØ³Ø¬ÙŠÙ„ Ø³Ù„ÙØ©</button>
    </div>

    <div class="subtle no-print">
      <h4>Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ©</h4>
      <div class="row">
        <div class="col"><label>Ø§Ù„Ù…ÙØ³Ù„Ù</label><select id="repay_person"></select></div>
        <div class="col"><input type="number" id="repay_amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
      </div>
      <input type="text" id="repay_note" class="slim" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      <button class="btn btn-outline" onclick="repayLoan()">â†©ï¸ ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯</button>
    </div>

    <div class="subtle">
      <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ³Ù„ÙÙŠÙ† ÙˆØ£Ø±ØµØ¯ØªÙ‡Ù…</h4>
      <div id="lendersList"></div>
    </div>

    <div class="subtle">
      <h4>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ù…ÙØ³Ù„Ù</h4>
      <div class="row no-print">
        <div class="col"><select id="l_stmt_person" onchange="renderLenderStatement()"></select></div>
        <div class="col"><button class="btn btn-outline" onclick="printSection('lenderStatement')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button></div>
        <div class="col"><button class="btn btn-outline" onclick="exportTableAsExcel('lenderStatementTable','ÙƒØ´Ù-Ù…Ø³Ù„Ù')">ğŸ“Š Excel</button></div>
      </div>
      <div id="lenderStatement"></div>
    </div>
  </section>

  <!-- ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ù‘Ø¹ -->
  <section class="card" data-tab="agg">
    <h3>ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ù‘Ø¹ (Ø­Ø³Ø¨ ÙØªØ±Ø©)</h3>
    <div class="row no-print">
      <div class="col"><label>Ù…Ù†</label><input type="date" id="f_from"></div>
      <div class="col"><label>Ø¥Ù„Ù‰</label><input type="date" id="f_to"></div>
      <div class="col">
        <label>Ø§Ù„Ù†Ø·Ø§Ù‚</label>
        <select id="agg_mode">
          <option value="all">Ù…Ø¬Ù…Ù‘Ø¹ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª</option>
          <option value="per">Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ Ù…Ø­Ù„</option>
        </select>
      </div>
    </div>
    <div style="margin-top:8px" class="no-print">
      <button class="btn btn-primary" onclick="generateAggregate()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      <button class="btn btn-outline" onclick="printSection('aggregateReport')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
      <button class="btn btn-outline" onclick="exportTableAsExcel('aggTable','ØªÙ‚Ø±ÙŠØ±-ÙØªØ±Ø©')">ğŸ“Š Excel</button>
    </div>
    <div id="aggregateReport"></div>
  </section>

</main>

<nav class="tabs no-print">
  <div class="tab active"><button onclick="showTab('input')">Ø¥Ø¯Ø®Ø§Ù„</button></div>
  <div class="tab"><button onclick="showTab('daily')">ÙŠÙˆÙ…ÙŠ</button></div>
  <div class="tab"><button onclick="showTab('traders')">ØªÙØ¬Ù‘Ø§Ø±</button></div>
  <div class="tab"><button onclick="showTab('loans')">Ø³ÙÙ„Ù</button></div>
  <div class="tab"><button onclick="showTab('agg')">Ù…Ø¬Ù…Ù‘Ø¹</button></div>
</nav>

<script>
// PWA
if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js')); }

// Stores & helpers
let currentStore='store1';
function labelOf(id){ return id==='store1'?'Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ':id==='store2'?'Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯':'Ø¨Ø³Ø·Ø©'; }
function changeStore(){ currentStore=document.getElementById('storeSelect').value; renderLists(); }
function getData(store=currentStore){ return JSON.parse(localStorage.getItem(store)||'{"sales":[],"expenses":[]}'); }
function saveData(d){ localStorage.setItem(currentStore, JSON.stringify(d)); }
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }

// Traders & Loans storage
function getTraders(){ return JSON.parse(localStorage.getItem('traders')||'{"list":[]}'); }
function saveTraders(v){ localStorage.setItem('traders', JSON.stringify(v)); }
function getLoans(){ return JSON.parse(localStorage.getItem('loans')||'{"list":[]}'); }
function saveLoans(v){ localStorage.setItem('loans', JSON.stringify(v)); }
function getOwnerLedger(){ return JSON.parse(localStorage.getItem('owner_cash_ledger')||'[]'); }
function saveOwnerLedger(a){ localStorage.setItem('owner_cash_ledger', JSON.stringify(a)); }

// Delete
function deleteSale(id){ const d=getData(); const i=d.sales.findIndex(x=>x.id===id); if(i>-1 && confirm('Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ØŸ')){ d.sales.splice(i,1); saveData(d); renderLists(); }}
function deleteExpense(id){ const d=getData(); const i=d.expenses.findIndex(x=>x.id===id); if(i>-1 && confirm('Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')){ d.expenses.splice(i,1); saveData(d); renderLists(); }}

// Sales
function addSale(){ const a=parseFloat(saleAmount.value),t=saleType.value,n=(saleNote.value||'').trim(); if(!a){alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­');return;} const d=getData(); d.sales.push({id:uid(),date:new Date().toLocaleDateString(),type:t,amount:a,note:n}); saveData(d); saleAmount.value=''; saleNote.value=''; renderLists(); }

// Expenses
function toggleExpenseTrader(on){ document.getElementById('expenseTraderRow').style.display = on?'flex':'none'; if(on) refreshTraderSelects(); }
function toggleExpenseLoan(on){ document.getElementById('expenseLoanRow').style.display = on?'flex':'none'; if(on) refreshLoanSelects(); }
function addExpense(){
  const desc=expenseDesc.value,a=parseFloat(expenseAmount.value),t=expenseType.value,n=(expenseNote.value||'').trim();
  if(!desc||!a){alert('Ø£Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ ØµØ­ÙŠØ­Ø©');return;}
  const d=getData(); d.expenses.push({id:uid(),date:new Date().toLocaleDateString(),desc:desc,type:t,amount:a,note:n}); saveData(d);

  if(document.getElementById('expenseIsTrader').checked){
    const tid=(expenseTrader||{}).value; const T=getTraders(); const tr=T.list.find(x=>x.id===tid);
    if(tr){ const payShopCash=(t==='ÙƒØ§Ø´')?a:0, payShopBank=(t==='Ø¨Ù†Ùƒ')?a:0;
      (tr.ledger||(tr.ledger=[])).push({id:uid(),type:'payment',date:new Date().toLocaleDateString(),amount:a,pay_shop_cash:payShopCash,pay_shop_bank:payShopBank,pay_owner_cash:0,note:(expenseTraderNote.value||'Ø³Ø¯Ø§Ø¯ ØªØ§Ø¬Ø± Ø¹Ø¨Ø± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ')+(n?` â€” (${n})`:'')});
      recomputeTrader(tr); saveTraders(T);
    }
  }
  if(document.getElementById('expenseIsLoan').checked){
    const lid=(expenseLoanPerson||{}).value; const Ls=getLoans(); const L=Ls.list.find(x=>x.id===lid);
    if(L){ (L.ledger||(L.ledger=[])).push({id:uid(),type:'use',date:new Date().toLocaleDateString(),amount:a,note:(expenseLoanNote.value||'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³Ù„ÙØ© Ù„Ù„Ù…ØµØ±ÙˆÙ')+(n?` â€” (${n})`:'')}); recomputeLender(L); saveLoans(Ls); }
  }
  expenseDesc.value=''; expenseAmount.value=''; expenseNote.value=''; if(expenseTraderNote) expenseTraderNote.value=''; if(expenseLoanNote) expenseLoanNote.value='';
  document.getElementById('expenseIsTrader').checked=false; toggleExpenseTrader(false);
  document.getElementById('expenseIsLoan').checked=false; toggleExpenseLoan(false);
  renderLists();
}

// Daily
function generateReport(){
  const date=r_date.value||new Date().toISOString().slice(0,10); r_date.value=date;
  const key=new Date(date).toLocaleDateString(),d=getData();
  const s=d.sales.filter(x=>x.date===key),e=d.expenses.filter(x=>x.date===key);
  const cs=s.filter(x=>x.type==='ÙƒØ§Ø´').reduce((a,b)=>a+b.amount,0),
        bs=s.filter(x=>x.type==='Ø¨Ù†Ùƒ').reduce((a,b)=>a+b.amount,0),
        ce=e.filter(x=>x.type==='ÙƒØ§Ø´').reduce((a,b)=>a+b.amount,0),
        be=e.filter(x=>x.type==='Ø¨Ù†Ùƒ').reduce((a,b)=>a+b.amount,0);
  k_cash_sales.textContent=cs; k_bank_sales.textContent=bs; k_cash_exp.textContent=ce; k_bank_exp.textContent=be; dailyKPI.style.display='grid';
  const salesRows=s.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.amount}</td><td>${x.note||''}</td><td class="no-print"><button class='btn btn-danger' onclick="deleteSale('${x.id}')">Ø­Ø°Ù</button></td></tr>`).join('')||'<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</td></tr>';
  const expRows=e.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.desc}</td><td>${x.amount}</td><td>${x.note||''}</td><td class="no-print"><button class='btn btn-danger' onclick="deleteExpense('${x.id}')">Ø­Ø°Ù</button></td></tr>`).join('')||'<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙŠÙˆÙ…</td></tr>';
  dailyReport.innerHTML=`<div class="hint">Ø§Ù„Ù…Ø­Ù„: <b>${labelOf(currentStore)}</b> â€” Ø§Ù„ØªØ§Ø±ÙŠØ®: <b>${new Date(date).toLocaleDateString()}</b></div>
  <div class="subtle">
    <details open><summary>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</summary>
      <table id="dailySales"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="no-print">Ø­Ø°Ù</th></tr></thead><tbody>${salesRows}</tbody></table>
    </details>
    <details open><summary>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</summary>
      <table id="dailyExpenses"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="no-print">Ø­Ø°Ù</th></tr></thead><tbody>${expRows}</tbody></table>
    </details>
  </div>`;
}
function exportDailyExcel(){
  const kpi=`<table><tr><th>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</th><th>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</th><th>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</th><th>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</th></tr>
  <tr><td>${k_cash_sales.textContent}</td><td>${k_bank_sales.textContent}</td><td>${k_cash_exp.textContent}</td><td>${k_bank_exp.textContent}</td></tr></table>`;
  const sales=document.getElementById('dailySales')?.outerHTML||'', exps=document.getElementById('dailyExpenses')?.outerHTML||'';
  const html=`<html><head><meta charset="utf-8"></head><body>${kpi}${sales}${exps}</body></html>`;
  downloadExcelHTML(html,'ØªÙ‚Ø±ÙŠØ±-ÙŠÙˆÙ…ÙŠ.xls');
}

// Traders
function refreshTraderSelects(){ const v=getTraders().list; [p_trader,pay_trader,s_trader,expenseTrader].forEach(sel=>{ if(!sel) return; sel.innerHTML=v.length? v.map(o=>`<option value="${o.id}">${o.name}</option>`).join(''):'<option value="">â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙØ¬Ù‘Ø§Ø± â€”</option>'; }); }
function renderTradersList(){ const v=getTraders().list; tradersList.innerHTML=v.length? v.map(o=>`<div class="item"><div class="meta"><b>${o.name}</b> ${o.phone?`â€” ${o.phone}`:''} <span class="hint">| Ø§Ù„Ø±ØµÙŠØ¯: ${o.balance||0}</span></div><div><button class="btn btn-danger" onclick="deleteTrader('${o.id}')">Ø­Ø°Ù</button></div></div>`).join(''):'<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙØ¬Ù‘Ø§Ø±</div>'; }
function addTrader(){ const name=(t_name.value||'').trim(),phone=(t_phone.value||'').trim(); if(!name){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±');return;} const data=getTraders(); data.list.push({id:uid(),name,phone,balance:0,ledger:[]}); saveTraders(data); t_name.value=''; t_phone.value=''; renderTradersUI(); }
function recomputeTrader(t){ let bal=0; (t.ledger||[]).forEach(e=>{ if(e.type==='purchase'){ const remain=(e.amount||0)-((e.pay_shop_cash||0)+(e.pay_shop_bank||0)+(e.pay_owner_cash||0)); bal+=remain; } else if(e.type==='payment'){ bal-=(e.amount||0); if(bal<0) bal=0; } e.balance_after=bal; }); t.balance=bal; }
function deleteTrader(id){ const T=getTraders(); const i=T.list.findIndex(x=>x.id===id); if(i>-1 && confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø± ÙˆØ¬Ù…ÙŠØ¹ Ø­Ø±ÙƒØ§ØªÙ‡ØŸ')){ T.list.splice(i,1); saveTraders(T); renderTradersUI(); } }
function deleteTraderEntry(tid,eid){ const T=getTraders(); const t=T.list.find(x=>x.id===tid); if(!t) return; const i=(t.ledger||[]).findIndex(x=>x.id===eid); if(i>-1 && confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')){ t.ledger.splice(i,1); recomputeTrader(t); saveTraders(T); renderTradersUI(); renderTraderStatement(); } }
function renderTraderStatement(){ const tid=s_trader.value; const data=getTraders(); const t=data.list.find(x=>x.id===tid); if(!t){ traderStatement.innerHTML='<div class="hint">Ø§Ø®ØªØ± ØªØ§Ø¬Ø±</div>'; return; } let rows=(t.ledger||[]).map(e=>`<tr><td>${e.date}</td><td>${e.type==='purchase'?'Ø´Ø±Ø§Ø¡':'Ø³Ø¯Ø§Ø¯'}</td><td>${e.note||''}</td><td>${e.amount}</td><td>${e.pay_shop_cash||0}</td><td>${e.pay_shop_bank||0}</td><td>${e.pay_owner_cash||0}</td><td>${e.balance_after||''}</td><td class="no-print"><button class="btn btn-danger" onclick="deleteTraderEntry('${t.id}','${e.id}')">Ø­Ø°Ù</button></td></tr>`).join(''); if(!rows) rows='<tr><td colspan="9">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>'; traderStatement.innerHTML=`<div class="hint">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${t.balance||0}</b></div><table id="traderStatementTable"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ø´</th><th>Ù…Ø¯ÙÙˆØ¹ Ø¨Ù†Ùƒ</th><th>Ù…Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯</th><th class="no-print">Ø­Ø°Ù</th></tr></thead><tbody>${rows}</tbody></table>`; }
function purchaseFromTrader(){
  const tid=p_trader.value,total=parseFloat(p_total.value)||0,sc=parseFloat(p_from_shop_cash.value)||0,sb=parseFloat(p_from_shop_bank.value)||0,oc=parseFloat(p_from_owner_cash.value)||0,n=(p_note.value||'').trim();
  if(!tid){alert('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø¬Ø±');return;} if(total<=0){alert('Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­Ø©');return;} if(sc+sb+oc>total){alert('Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø£ÙƒØ¨Ø± Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©');return;}
  const T=getTraders(); const t=T.list.find(x=>x.id===tid); (t.ledger||(t.ledger=[])).push({id:uid(),type:'purchase',date:new Date().toLocaleDateString(),amount:total,pay_shop_cash:sc,pay_shop_bank:sb,pay_owner_cash:oc,note:n}); recomputeTrader(t); saveTraders(T);
  if(sc>0){ const d=getData(); d.expenses.push({id:uid(),date:new Date().toLocaleDateString(),desc:`Ø´Ø±Ø§Ø¡ Ø¨Ø¶Ø§Ø¹Ø© Ù…Ù† ${t.name}`,type:'ÙƒØ§Ø´',amount:sc,note:'Ø¯ÙØ¹Ø© Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„'}); saveData(d); }
  if(sb>0){ const d=getData(); d.expenses.push({id:uid(),date:new Date().toLocaleDateString(),desc:`Ø´Ø±Ø§Ø¡ Ø¨Ø¶Ø§Ø¹Ø© Ù…Ù† ${t.name}`,type:'Ø¨Ù†Ùƒ',amount:sb,note:'Ø¯ÙØ¹Ø© Ù…Ù† Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø­Ù„'}); saveData(d); }
  if(oc>0){ const l=getOwnerLedger(); l.push({id:uid(),kind:'use',date:new Date().toLocaleDateString(),shop:'-',amount:oc,note:`Ø¯ÙØ¹Ø© ØªØ§Ø¬Ø± (${t.name}) Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ`,batch_id:null}); saveOwnerLedger(l); }
  p_total.value=''; p_from_shop_cash.value=''; p_from_shop_bank.value=''; p_from_owner_cash.value=''; p_note.value=''; renderLists(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©.');
}
function payTrader(){
  const tid=pay_trader.value,src=pay_source.value,amt=parseFloat(pay_amount.value)||0,n=(pay_note.value||'').trim(); if(!tid){alert('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø¬Ø±');return;} if(amt<=0){alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');return;}
  const T=getTraders(); const t=T.list.find(x=>x.id===tid); let sc=0,sb=0,oc=0; if(src==='shop_cash') sc=amt; if(src==='shop_bank') sb=amt; if(src==='owner_cash') oc=amt;
  (t.ledger||(t.ledger=[])).push({id:uid(),type:'payment',date:new Date().toLocaleDateString(),amount:amt,pay_shop_cash:sc,pay_shop_bank:sb,pay_owner_cash:oc,note:n}); recomputeTrader(t); saveTraders(T);
  if(sc>0){ const d=getData(); d.expenses.push({id:uid(),date:new Date().toLocaleDateString(),desc:`Ø³Ø¯Ø§Ø¯ ØªØ§Ø¬Ø± ${t.name}`,type:'ÙƒØ§Ø´',amount:sc,note:n||'Ø³Ø¯Ø§Ø¯ Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„'}); saveData(d); }
  if(sb>0){ const d=getData(); d.expenses.push({id:uid(),date:new Date().toLocaleDateString(),desc:`Ø³Ø¯Ø§Ø¯ ØªØ§Ø¬Ø± ${t.name}`,type:'Ø¨Ù†Ùƒ',amount:sb,note:n||'Ø³Ø¯Ø§Ø¯ Ù…Ù† Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø­Ù„'}); saveData(d); }
  if(oc>0){ const l=getOwnerLedger(); l.push({id:uid(),kind:'use',date:new Date().toLocaleDateString(),shop:'-',amount:oc,note:n||`Ø³Ø¯Ø§Ø¯ ØªØ§Ø¬Ø± (${t.name}) Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ`,batch_id:null}); saveOwnerLedger(l); }
  pay_amount.value=''; pay_note.value=''; renderLists(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯.');
}

// Loans
function refreshLoanSelects(){ const v=getLoans().list; [loan_person,repay_person,l_stmt_person,expenseLoanPerson].forEach(sel=>{ if(!sel) return; sel.innerHTML=v.length? v.map(o=>`<option value="${o.id}">${o.name}</option>`).join(''):'<option value="">â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØ³Ù„ÙÙˆÙ† â€”</option>'; }); }
function renderLendersList(){ const v=getLoans().list; lendersList.innerHTML=v.length? v.map(o=>{ const adv=o.advanced||0,used=o.used||0,rep=o.repaid||0, stillOnUs=adv-rep, remain=Math.max(0,adv-used); return `<div class="item"><div class="meta"><b>${o.name}</b> ${o.phone?`â€” ${o.phone}`:''}</div><div><button class="btn btn-danger" onclick="deleteLender('${o.id}')">Ø­Ø°Ù</button></div></div><div class="hint">Ø¹Ù„ÙŠÙ†Ø§ Ø§Ù„Ø¢Ù†: <b>${stillOnUs}</b> â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…: <b>${remain}</b></div>`; }).join(''):'<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØ³Ù„ÙÙˆÙ†</div>'; }
function renderLenderStatement(){ const id=(l_stmt_person||{}).value; const D=getLoans(); const L=D.list.find(x=>x.id===id); if(!L){ lenderStatement.innerHTML='<div class="hint">Ø§Ø®ØªØ± Ù…ÙØ³Ù„Ù</div>'; return; } let rows=(L.ledger||[]).map(e=>`<tr><td>${e.date}</td><td>${e.type==='advance'?'Ø³Ù„ÙØ©':e.type==='repay'?'Ø³Ø¯Ø§Ø¯':'Ø§Ø³ØªØ®Ø¯Ø§Ù…'}</td><td>${e.note||''}</td><td>${e.amount}</td><td class="no-print"><button class="btn btn-danger" onclick="deleteLenderEntry('${L.id}','${e.id}')">Ø­Ø°Ù</button></td></tr>`).join(''); if(!rows) rows='<tr><td colspan="5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>'; const adv=L.advanced||0,used=L.used||0,rep=L.repaid||0, stillOnUs=adv-rep, remain=Math.max(0,adv-used); lenderStatement.innerHTML=`<div class="hint">Ø¹Ù„ÙŠÙ†Ø§ Ø§Ù„Ø¢Ù†: <b>${stillOnUs}</b> â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…: <b>${remain}</b></div><table id="lenderStatementTable"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th class="no-print">Ø­Ø°Ù</th></tr></thead><tbody>${rows}</tbody></table>`; }
function recomputeLender(L){ let adv=0,used=0,rep=0; (L.ledger||[]).forEach(e=>{ if(e.type==='advance') adv+=(e.amount||0); else if(e.type==='use') used+=(e.amount||0); else if(e.type==='repay') rep+=(e.amount||0); }); L.advanced=adv; L.used=used; L.repaid=rep; }
function addLender(){ const name=(l_name.value||'').trim(),phone=(l_phone.value||'').trim(); if(!name){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙØ³Ù„Ù');return;} const D=getLoans(); D.list.push({id:uid(),name,phone,ledger:[],advanced:0,used:0,repaid:0}); saveLoans(D); l_name.value=''; l_phone.value=''; renderLoansUI(); }
function deleteLender(id){ const D=getLoans(); const i=D.list.findIndex(x=>x.id===id); if(i>-1 && confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØ³Ù„Ù ÙˆØ¬Ù…ÙŠØ¹ Ø­Ø±ÙƒØ§ØªÙ‡ØŸ')){ D.list.splice(i,1); saveLoans(D); renderLoansUI(); } }
function deleteLenderEntry(lid,eid){ const D=getLoans(); const L=D.list.find(x=>x.id===lid); if(!L) return; const i=(L.ledger||[]).findIndex(x=>x.id===eid); if(i>-1 && confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')){ L.ledger.splice(i,1); recomputeLender(L); saveLoans(D); renderLoansUI(); renderLenderStatement(); } }
function takeLoan(){ const id=(loan_person||{}).value,amt=parseFloat(loan_amount.value)||0,n=(loan_note.value||'').trim(); if(!id||!amt){alert('Ø£Ø¯Ø®Ù„ Ù…ÙØ³Ù„Ù ÙˆÙ…Ø¨Ù„Øº');return;} const D=getLoans(); const L=D.list.find(x=>x.id===id); (L.ledger||(L.ledger=[])).push({id:uid(),type:'advance',date:new Date().toLocaleDateString(),amount:amt,note:n}); recomputeLender(L); saveLoans(D); loan_amount.value=''; loan_note.value=''; renderLoansUI(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©.'); }
function repayLoan(){ const id=(repay_person||{}).value,amt=parseFloat(repay_amount.value)||0,n=(repay_note.value||'').trim(); if(!id||!amt){alert('Ø£Ø¯Ø®Ù„ Ù…ÙØ³Ù„Ù ÙˆÙ…Ø¨Ù„Øº');return;} const D=getLoans(); const L=D.list.find(x=>x.id===id); (L.ledger||(L.ledger=[])).push({id:uid(),type:'repay',date:new Date().toLocaleDateString(),amount:amt,note:n}); recomputeLender(L); saveLoans(D); repay_amount.value=''; repay_note.value=''; renderLoansUI(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯.'); }
function renderTradersUI(){ refreshTraderSelects(); renderTradersList(); renderTraderStatement(); }
function renderLoansUI(){ refreshLoanSelects(); renderLendersList(); renderLenderStatement(); }

// Aggregate
function generateAggregate(){
  const from=f_from.value,to=f_to.value,mode=agg_mode.value; if(!from||!to){alert('Ø§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø© (Ù…Ù†/Ø¥Ù„Ù‰)');return;}
  const shops=['store1','store2','store3'];
  const rangeOK=dstr=>{ const d=new Date(dstr.split('/').reverse().join('-')); return d>=new Date(from)&&d<=new Date(to); };
  let html='';
  if(mode==='all'){
    let tot={cs:0,bs:0,ce:0,be:0,net:0};
    shops.forEach(st=>{ const d=getData(st); const cs=d.sales.filter(x=>x.type==='ÙƒØ§Ø´'&&rangeOK(x.date)).reduce((a,b)=>a+b.amount,0); const bs=d.sales.filter(x=>x.type==='Ø¨Ù†Ùƒ'&&rangeOK(x.date)).reduce((a,b)=>a+b.amount,0); const ce=d.expenses.filter(x=>x.type==='ÙƒØ§Ø´'&&rangeOK(x.date)).reduce((a,b)=>a+b.amount,0); const be=d.expenses.filter(x=>x.type==='Ø¨Ù†Ùƒ'&&rangeOK(x.date)).reduce((a,b)=>a+b.amount,0); tot.cs+=cs; tot.bs+=bs; tot.ce+=ce; tot.be+=be; });
    tot.net=tot.cs+tot.bs-(tot.ce+tot.be);
    html+=`<table id="aggTable"><thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody>
           <tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</td><td>${tot.cs}</td></tr>
           <tr><td>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</td><td>${tot.bs}</td></tr>
           <tr><td>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</td><td>${tot.ce}</td></tr>
           <tr><td>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</td><td>${tot.be}</td></tr>
           <tr><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>${tot.net}</th></tr></tbody></table>`;
  }else{
    html+=`<table id="aggTable"><thead><tr><th>Ø§Ù„Ù…Ø­Ù„</th><th>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</th><th>Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ùƒ</th><th>Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ§Ø´</th><th>Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ùƒ</th><th>ØµØ§ÙÙŠ</th></tr></thead><tbody>`;
    shops.forEach(st=>{ const d=getData(st); const cs=d.sales.filter(x=>x.type==='ÙƒØ§Ø´'&&rangeOK(x.date)).reduce((a,b)=>a+b.amount,0); const bs=d.sales.filter(x=>x.type==='Ø¨Ù†Ùƒ'&&rangeOK(x.date)).reduce((a,b)=>a+b.amount,0); const ce=d.expenses.filter(x=>x.type==='ÙƒØ§Ø´'&&rangeOK(x.date)).reduce((a,b)=>a+b.amount,0); const be=d.expenses.filter(x=>x.type==='Ø¨Ù†Ùƒ'&&rangeOK(x.date)).reduce((a,b)=>a+b.amount,0); const net=cs+bs-(ce+be); html+=`<tr><td>${labelOf(st)}</td><td>${cs}</td><td>${bs}</td><td>${ce}</td><td>${be}</td><td>${net}</td></tr>`; });
    html+='</tbody></table>';
  }
  aggregateReport.innerHTML=`<div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${from}</b> â†’ <b>${to}</b></div>`+html;
}

// Excel export
function exportTableAsExcel(tableId, name){ const t=document.getElementById(tableId); if(!t){alert('Ø§Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹');return;} const html=`<html><head><meta charset="utf-8"></head><body>${t.outerHTML}</body></html>`; downloadExcelHTML(html, name+'.xls'); }
function downloadExcelHTML(html, filename){ const blob=new Blob([html],{type:'application/vnd.ms-excel'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},500); }

// Print
function printSection(id){ const el=document.getElementById(id); if(!el){alert('Ø§Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹');return;} const h=document.head.innerHTML; const w=window.open('','_blank'); w.document.write(`<html><head>${h}</head><body>${el.outerHTML}</body></html>`); w.document.close(); w.focus(); w.print(); w.close(); }

// UI boot
function showTab(name){ document.querySelectorAll('[data-tab]').forEach(s=>s.style.display=(s.getAttribute('data-tab')===name)?'block':'none'); const keys=['input','daily','traders','loans','agg']; document.querySelectorAll('.tabs .tab').forEach((t,i)=>t.classList.toggle('active',keys[i]===name)); if(name==='input') renderLists(); if(name==='traders') renderTradersUI(); if(name==='loans') renderLoansUI(); }
function renderLists(){ const d=getData(); const rs=d.sales.slice(-20).reverse(), re=d.expenses.slice(-20).reverse(); recentSales.innerHTML=rs.map(v=>`<div class="item"><div class="meta">${v.date} â€” ${v.type}${v.note?` â€” <i>${v.note}</i>`:''}</div><div><button class="btn btn-danger" onclick="deleteSale('${v.id}')">Ø­Ø°Ù</button></div><b>${v.amount}</b></div>`).join('')||'<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯</div>'; recentExpenses.innerHTML=re.map(v=>`<div class="item"><div class="meta">${v.date} â€” ${v.type} â€” ${v.desc}${v.note?` â€” <i>${v.note}</i>`:''}</div><div><button class="btn btn-danger" onclick="deleteExpense('${v.id}')">Ø­Ø°Ù</button></div><b>${v.amount}</b></div>`).join('')||'<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ø¨Ø¹Ø¯</div>'; }
document.addEventListener('DOMContentLoaded',()=>{ const today=new Date().toISOString().slice(0,10); if(r_date) r_date.value=today; if(f_from) f_from.value=today.slice(0,8)+'01'; if(f_to) f_to.value=today; showTab('input'); renderLists(); });
</script>
</body>
</html>
